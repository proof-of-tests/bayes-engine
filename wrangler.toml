name = "bayes-engine"
main = "result/worker/worker.js"
compatibility_date = "2024-10-01"

[build]
command = "nix build .#webapp"

# Serve static assets (HTML, CSS, WASM) from the assets directory
# CloudFlare Workers will automatically serve these files
[assets]
directory = "result/assets"
# Enable SPA mode: serve index.html for any route that doesn't match a static file
# This allows client-side routing to work with direct URL access
not_found_handling = "single-page-application"

# Hyperdrive database binding for Postgres connectivity
[[hyperdrive]]
binding = "HYPERDRIVE"
id = "a88d53af1e344d80bdd1ab8f88692b14"

# Production environment - includes custom domain routes
[env.production]
routes = [
  { pattern = "bayes.lemmih.com", zone_name = "lemmih.com", custom_domain = true }
]

[[env.production.hyperdrive]]
binding = "HYPERDRIVE"
id = "a88d53af1e344d80bdd1ab8f88692b14"

[env.production.assets]
directory = "result/assets"
not_found_handling = "single-page-application"

# E2E testing environment - uses pre-compiled files without running build
[env.e2e]
# No build command - assumes result/ directory already exists with compiled files

# Hyperdrive for e2e tests - requires CLOUDFLARE_HYPERDRIVE_LOCAL_CONNECTION_STRING_HYPERDRIVE
# environment variable to be set (e.g., from GitHub secrets)
[[env.e2e.hyperdrive]]
binding = "HYPERDRIVE"
id = "a88d53af1e344d80bdd1ab8f88692b14"

[env.e2e.assets]
directory = "result/assets"
not_found_handling = "single-page-application"
