name: CI WASM Upload PoC

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  upload-wasm:
    name: Upload Sample WASM to bayes.lemmih.com
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    permissions:
      contents: read
      id-token: write
    env:
      DRY_RUN: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}
      UPLOAD_URL: ${{ github.event_name == 'pull_request' && format('https://bayes-engine-pr-{0}.lemmih.workers.dev/api/ci-upload', github.event.pull_request.number) || 'https://bayes.lemmih.com/api/ci-upload' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build webapp
        run: nix build .#webapp

      - name: Prepare WASM metadata
        id: wasm
        shell: bash
        run: |
          set -euo pipefail

          WASM_FILE=""
          for CANDIDATE in \
            "result/worker/server_bg.wasm" \
            "result/assets/pkg/client_bg.wasm"; do
            if [ -f "$CANDIDATE" ]; then
              WASM_FILE="$CANDIDATE"
              break
            fi
          done

          if [ -z "$WASM_FILE" ]; then
            echo "Expected WASM file not found in result outputs" >&2
            find -L result -maxdepth 4 -type f | sort >&2 || true
            exit 1
          fi

          WASM_SHA256=$(sha256sum "$WASM_FILE" | awk '{print $1}')
          WASM_SIZE=$(stat -c%s "$WASM_FILE")

          echo "wasm_file=$WASM_FILE" >> "$GITHUB_OUTPUT"
          echo "wasm_sha256=$WASM_SHA256" >> "$GITHUB_OUTPUT"
          echo "wasm_size=$WASM_SIZE" >> "$GITHUB_OUTPUT"

      - name: Request GitHub OIDC token
        id: oidc
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]; then
            echo "GitHub OIDC env vars are missing" >&2
            exit 1
          fi

          OIDC_RESPONSE=$(curl -sSf \
            -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=bayes-engine-ci-upload")

          OIDC_TOKEN=$(printf '%s' "$OIDC_RESPONSE" | node -e 'const fs=require("fs");const d=JSON.parse(fs.readFileSync(0,"utf8"));process.stdout.write(d.value || "");')

          if [ -z "$OIDC_TOKEN" ]; then
            echo "Failed to obtain OIDC token" >&2
            exit 1
          fi

          echo "oidc_token=$OIDC_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Wait for preview deployment (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail

          PREVIEW_BASE="https://bayes-engine-pr-${{ github.event.pull_request.number }}.lemmih.workers.dev"
          echo "Waiting for preview deployment at ${PREVIEW_BASE}..."

          for i in $(seq 1 30); do
            if curl -sS -o /dev/null "${PREVIEW_BASE}/content-hash.txt"; then
              echo "Preview deployment is ready."
              exit 0
            fi
            sleep 10
          done

          echo "Preview deployment not ready after waiting." >&2
          exit 1

      - name: Upload WASM to bayes.lemmih.com
        id: upload
        shell: bash
        run: |
          set -euo pipefail

          HTTP_CODE=$(curl -sS \
            -o upload-response.json \
            -w "%{http_code}" \
            -X POST "${UPLOAD_URL}" \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.oidc_token }}" \
            -F "file=@${{ steps.wasm.outputs.wasm_file }}" \
            -F "declared_sha256=${{ steps.wasm.outputs.wasm_sha256 }}" \
            -F "dry_run=${DRY_RUN}")


          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Upload request failed with HTTP ${HTTP_CODE}" >&2
            cat upload-response.json >&2 || true
            exit 1
          fi

          cat upload-response.json

      - name: Validate server response
        shell: bash
        run: |
          set -euo pipefail

          node - <<'NODE'
          const fs = require('fs');
          const response = JSON.parse(fs.readFileSync('upload-response.json', 'utf8'));
          const expectedHash = process.env.EXPECTED_HASH;

          if (!response.ok) {
            throw new Error(`Upload failed: ${response.code || 'unknown'} ${response.error || ''}`);
          }

          if (response.wasm_sha256 !== expectedHash) {
            throw new Error(`SHA mismatch: expected ${expectedHash}, got ${response.wasm_sha256}`);
          }

          if (!response.repository || !response.repository_id) {
            throw new Error('Missing repository metadata in response');
          }

          if (String(response.dry_run) !== String(process.env.EXPECTED_DRY_RUN)) {
            throw new Error(`dry_run mismatch: expected ${process.env.EXPECTED_DRY_RUN}, got ${response.dry_run}`);
          }

          console.log('Response validated successfully.');
          NODE
        env:
          EXPECTED_HASH: ${{ steps.wasm.outputs.wasm_sha256 }}
          EXPECTED_DRY_RUN: ${{ env.DRY_RUN }}

      - name: Add workflow summary
        shell: bash
        run: |
          {
            echo "## CI Upload PoC Result"
            echo ""
            echo "- Mode: ${{ env.DRY_RUN == 'true' && 'dry-run' || 'live' }}"
            echo "- Trigger: ${{ github.event_name }}"
            echo "- Upload URL: `${{ env.UPLOAD_URL }}`"
            echo "- Uploaded file: \`${{ steps.wasm.outputs.wasm_file }}\`"
            echo "- File size: ${{ steps.wasm.outputs.wasm_size }} bytes"
            echo "- Declared SHA-256: \`${{ steps.wasm.outputs.wasm_sha256 }}\`"
            echo ""
            echo "### Server Response"
            echo '```json'
            cat upload-response.json
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
