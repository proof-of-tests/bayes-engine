name: CI WASM Upload PoC

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  upload-wasm:
    name: Test WASM Upload (Local Server)
    runs-on: ubuntu-24.04
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
    permissions:
      contents: read
      id-token: write
    env:
      UPLOAD_URL: "http://localhost:8787/api/ci-upload"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build webapp
        run: nix build .#webapp

      - name: Build PoW test WASM module
        run: nix build .#powTestFunctionsModule --out-link result-pow-test

      - name: Build wrangler
        run: |
          # Pre-build wrangler to ensure it's cached before running in background
          # This avoids timeout issues when wrangler is not yet in the nix cache
          nix run .#wrangler-dev -- --help > /dev/null 2>&1 || true

      - name: Prepare WASM metadata
        id: wasm
        shell: bash
        run: |
          set -euo pipefail

          WASM_FILE=""
          for CANDIDATE in \
            "result-pow-test/pow_test_functions.wasm" \
            "result/worker/server_bg.wasm" \
            "result/assets/pkg/client_bg.wasm"; do
            if [ -f "$CANDIDATE" ]; then
              WASM_FILE="$CANDIDATE"
              break
            fi
          done

          if [ -z "$WASM_FILE" ]; then
            echo "Expected WASM file not found in result outputs" >&2
            find -L result -maxdepth 4 -type f | sort >&2 || true
            exit 1
          fi

          WASM_SHA256=$(sha256sum "$WASM_FILE" | awk '{print $1}')
          WASM_SIZE=$(stat -c%s "$WASM_FILE")

          echo "wasm_file=$WASM_FILE" >> "$GITHUB_OUTPUT"
          echo "wasm_sha256=$WASM_SHA256" >> "$GITHUB_OUTPUT"
          echo "wasm_size=$WASM_SIZE" >> "$GITHUB_OUTPUT"

      - name: Request GitHub OIDC token
        id: oidc
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]; then
            echo "GitHub OIDC env vars are missing" >&2
            exit 1
          fi

          OIDC_RESPONSE=$(curl -sSf \
            -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=bayes-engine-ci-upload")

          OIDC_TOKEN=$(printf '%s' "$OIDC_RESPONSE" | node -e 'const fs=require("fs");const d=JSON.parse(fs.readFileSync(0,"utf8"));process.stdout.write(d.value || "");')

          if [ -z "$OIDC_TOKEN" ]; then
            echo "Failed to obtain OIDC token" >&2
            exit 1
          fi

          echo "oidc_token=$OIDC_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Start wrangler dev server
        shell: bash
        run: |
          set -euo pipefail

          # Start wrangler in background with e2e environment
          nix run .#wrangler-dev -- --env e2e --port 8787 > wrangler.log 2>&1 &
          WRANGLER_PID=$!
          echo "WRANGLER_PID=$WRANGLER_PID" >> "$GITHUB_ENV"
          echo "Wrangler started with PID $WRANGLER_PID"

          # Wait for wrangler to be ready
          for i in $(seq 1 30); do
            if curl -sf "http://localhost:8787" > /dev/null 2>&1; then
              echo "Wrangler is ready!"
              exit 0
            fi
            echo "Waiting for wrangler (attempt $i/30)..."
            sleep 2
          done

          echo "Wrangler failed to start within 60 seconds"
          cat wrangler.log || true
          exit 1
        env:
          CLOUDFLARE_HYPERDRIVE_LOCAL_CONNECTION_STRING_HYPERDRIVE: ${{ secrets.NEON_DATABASE_URL }}

      - name: Upload WASM to local server
        id: upload
        shell: bash
        run: |
          set -euo pipefail

          HTTP_CODE=$(curl -sS \
            -o upload-response.json \
            -w "%{http_code}" \
            -X POST "${UPLOAD_URL}" \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.oidc_token }}" \
            -F "file=@${{ steps.wasm.outputs.wasm_file }}" \
            -F "declared_sha256=${{ steps.wasm.outputs.wasm_sha256 }}" \
            -F "version=${GITHUB_SHA}")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Upload succeeded with HTTP $HTTP_CODE"
            cat upload-response.json
          else
            echo "Upload request failed with HTTP ${HTTP_CODE}" >&2
            cat upload-response.json >&2 || true
            exit 1
          fi

      - name: Validate server response
        shell: bash
        run: |
          set -euo pipefail

          node - <<'NODE'
          const fs = require('fs');
          const response = JSON.parse(fs.readFileSync('upload-response.json', 'utf8'));
          const expectedHash = process.env.EXPECTED_HASH;

          if (!response.ok) {
            throw new Error(`Upload failed: ${response.code || 'unknown'} ${response.error || ''}`);
          }

          if (response.wasm_sha256 !== expectedHash) {
            throw new Error(`SHA mismatch: expected ${expectedHash}, got ${response.wasm_sha256}`);
          }

          if (!response.repository || !response.repository_id) {
            throw new Error('Missing repository metadata in response');
          }

          console.log('Response validated successfully.');
          NODE
        env:
          EXPECTED_HASH: ${{ steps.wasm.outputs.wasm_sha256 }}

      - name: Stop wrangler dev server
        if: always()
        shell: bash
        run: |
          if [ -n "${WRANGLER_PID:-}" ]; then
            echo "Stopping wrangler (PID $WRANGLER_PID)..."
            kill "$WRANGLER_PID" 2>/dev/null || true
            # Also kill any child processes
            pkill -P "$WRANGLER_PID" 2>/dev/null || true
          fi

      - name: Add workflow summary
        if: always()
        shell: bash
        run: |
          {
            echo "## CI Upload PoC Result"
            echo ""
            echo "- Trigger: ${{ github.event_name }}"
            echo "- Server: Local wrangler dev (isolated from production)"
            echo "- Database: PostgreSQL via Hyperdrive"
            echo "- Uploaded file: \`${{ steps.wasm.outputs.wasm_file }}\`"
            echo "- File size: ${{ steps.wasm.outputs.wasm_size }} bytes"
            echo "- Declared SHA-256: \`${{ steps.wasm.outputs.wasm_sha256 }}\`"
            echo ""
            if [ -f upload-response.json ]; then
              echo "### Server Response"
              echo '```json'
              cat upload-response.json
              echo '```'
            else
              echo "### Server Response"
              echo "_No response file available_"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
